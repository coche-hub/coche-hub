{% extends "base_template.html" %} {% block title %}Edit {{ community.name }}{%
endblock %} {% block content %}
<div class="container mt-4">
  {# Show flashed messages (e.g. resolver errors from add_curator) #} {% with
  messages = get_flashed_messages(with_categories=true) %} {% if messages %} {%
  for category, message in messages %}
  <div
    class="alert alert-{{ 'warning' if category == 'warning' else category }}"
    role="alert"
  >
    {{ message }}
  </div>
  {% endfor %} {% endif %} {% endwith %}
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h3>Edit Community: {{ community.name }}</h3>
        </div>
        <div class="card-body">
          <form
            method="POST"
            action="{{ url_for('community.edit', community_id=community.id) }}"
          >
            {{ form.hidden_tag() }} {% if form.errors.general %}
            <div class="alert alert-danger">{{ form.errors.general[0] }}</div>
            {% endif %}

            <div class="mb-3">
              {{ form.name.label(class="form-label") }} {{
              form.name(class="form-control" + (" is-invalid" if
              form.name.errors else "")) }} {% if form.name.errors %}
              <div class="invalid-feedback">{{ form.name.errors[0] }}</div>
              {% endif %}
            </div>

            <div class="mb-3">
              {{ form.description.label(class="form-label") }} {{
              form.description(class="form-control", rows=5) }} {% if
              form.description.errors %}
              <div class="invalid-feedback d-block">
                {{ form.description.errors[0] }}
              </div>
              {% endif %}
            </div>

            <div class="mb-3">
              {{ form.logo.label(class="form-label") }} {{
              form.logo(class="form-control" + (" is-invalid" if
              form.logo.errors else "")) }} {% if form.logo.errors %}
              <div class="invalid-feedback">{{ form.logo.errors[0] }}</div>
              {% endif %}
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <a
                href="{{ url_for('community.detail', community_id=community.id) }}"
                class="btn btn-secondary"
                >Cancel</a
              >
              <button type="submit" class="btn btn-primary">
                Save Changes
              </button>
            </div>

            <hr class="mt-4" />

            <!-- Curators management: same fields as Authors in upload_dataset.html -->
            <h5 class="mt-3">Curators</h5>

            <div class="mb-3">
              {% if curators %}
              <ul class="list-unstyled">
                {% for curator in curators %}
                <li class="mb-2">
                  <i class="fas fa-user"></i>
                  {{ curator.user.email if curator.user else 'Unknown User' }}
                  {# Removal of curators is disabled. #}
                </li>
                {% endfor %}
              </ul>
              {% else %}
              <p class="text-muted">No curators assigned.</p>
              {% endif %}
            </div>

            <div class="card mt-3">
              <div class="card-body">
                <h6>Add curator</h6>
                <!-- Use same add-curator component as create page -->
                <div
                  id="curators_error"
                  class="text-danger mb-2"
                  style="display: none"
                ></div>
                <div class="row g-2 align-items-end">
                  <div class="col-lg-5 col-12">
                    <label class="form-label">Name *</label>
                    <input
                      id="new_curator_name"
                      class="form-control"
                      type="text"
                    />
                  </div>
                  <div class="col-lg-4 col-12">
                    <label class="form-label">Affiliation</label>
                    <input
                      id="new_curator_affiliation"
                      class="form-control"
                      type="text"
                    />
                  </div>
                  <div class="col-lg-3 col-12">
                    <label class="form-label">ORCID</label>
                    <input
                      id="new_curator_orcid"
                      class="form-control"
                      type="text"
                      placeholder="0000-0000-0000-0000"
                    />
                  </div>
                </div>

                <div class="mt-2">
                  <button
                    type="button"
                    id="add_curator_to_list"
                    class="btn btn-secondary btn-sm"
                  >
                    Add curator
                  </button>
                </div>

                <ul id="curators_list" class="mt-3 list-unstyled"></ul>

                <!-- Hidden container where we append inputs so they are submitted with the form -->
                <div id="curators_hidden_container"></div>
              </div>
            </div>
          </form>

          <script>
            (function(){
              const addBtn = document.getElementById('add_curator_to_list');
              const nameInput = document.getElementById('new_curator_name');
              const affInput = document.getElementById('new_curator_affiliation');
              const orcidInput = document.getElementById('new_curator_orcid');
              const list = document.getElementById('curators_list');
              // Prefer the hidden container, but as a fallback append hidden inputs directly to the enclosing form
              const hidden = document.getElementById('curators_hidden_container') || (document.querySelector('form'));
              const err = document.getElementById('curators_error') || (function(){
                const e = document.createElement('div'); e.style.display='none'; return e; })();

              function normalizeOrcid(v){ return v.replace(/\s+/g,''); }

              // In the edit flow we submit additions to the server instead of
              // mutating the client-side list. The Add button's server-submit
              // handler is defined later; do not add a local append handler here.

              // Note: We do NOT populate hidden inputs for existing curators.
              // Existing curators are already in the database and don't need to be
              // resubmitted with every form edit. Only new curators added via the
              // "Add curator" button need to be sent to the server.

              // Override Add button behavior: submit a small POST to the server to add the curator
              // and reload/redirect back to the edit page so the curator list is refreshed server-side.
              addBtn.addEventListener('click', function(){
                if(err) err.style.display = 'none';
                const name = nameInput.value.trim();
                const affiliation = affInput.value.trim();
                const orcid = normalizeOrcid(orcidInput.value.trim());

                if(!name){
                  if(err){ err.textContent = 'Name is required for curator.'; err.style.display='block'; }
                  return;
                }

                // Build a temporary form and submit it to the server so we get a full reload/redirect
                const tempForm = document.createElement('form');
                tempForm.method = 'POST';
                tempForm.action = '{{ url_for('community.add_curator', community_id=community.id) }}';

                // include CSRF token from the main form if present
                const csrfInput = document.querySelector('input[name="csrf_token"]');
                if(csrfInput){
                  const t = document.createElement('input'); t.type='hidden'; t.name='csrf_token'; t.value = csrfInput.value;
                  tempForm.appendChild(t);
                }

                if(orcid){
                  const o = document.createElement('input'); o.type='hidden'; o.name='orcid'; o.value = orcid; tempForm.appendChild(o);
                } else {
                  const n = document.createElement('input'); n.type='hidden'; n.name='name'; n.value = name; tempForm.appendChild(n);
                }

                // append to body and submit
                document.body.appendChild(tempForm);
                tempForm.submit();
              });
            })();
          </script>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
