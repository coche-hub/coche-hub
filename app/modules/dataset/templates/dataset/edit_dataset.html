{% extends "base_template.html" %}

{% block title %}Edit dataset - Create New Version{% endblock %}

{% block content %}

    <h1 class="h2 mb-3"><b>Edit</b> dataset - Create New Version</h1>
    
    <div class="row">
        <div class="col-12 mb-3">
            <div class="alert alert-info" role="alert">
                <div class="alert-message">
                    <h4 class="alert-heading"><i class="align-middle" data-feather="info"></i> Creating a new version</h4>
                    <p class="p-0 m-0">
                        You are creating a new version of this dataset (current version: {{ dataset.version }}). 
                        The version number will be automatically incremented to version {{ dataset.version + 1 }}.
                        You can modify the dataset information and add more files. Existing files are shown below.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12 mb-3">
            <div class="alert alert-warning" role="alert" id="test_zenodo_connection_error" style="display: none">
                <div class="alert-message">

                    <h4 class="alert-heading"><i class="align-middle" data-feather="alert-triangle"></i> Limited
                        connection to the Zenodo API</h4>
                    <p class="p-0 m-0">
                        There seems to be some kind of problem with the Zenodo API and synchronization of your dataset
                        files may not be possible. We will save your files locally to eventually synchronize them with
                        Zenodo. Sorry for the inconvenience, Zenodo is an external service and we can't do
                        anything about it.
                    </p>
                </div>
            </div>
        </div>

    </div>

    {% if messages %}
        <ul>
            {% for message in messages %}
                <li>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="row">

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
            <div id="basic_info_form">

                {{ form.hidden_tag() }}

                <div class="row">

                    <div class="col-12">

                        <h1 class="h3 mb-3">Basic info</h1>

                        <div class="row" style="padding-left: 2rem">
                            
                            <div class="col-lg-6 col-xs-12 col-md-12">
                                <div class="mb-3">
                                    {{ form.title.label(class="form-label") }} *
                                    {{ form.title(class="form-control") }}
                                    {% for error in form.title.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="mb-3">
                                    {{ form.desc.label(class="form-label") }} *
                                    {{ form.desc(rows=4, class="form-control") }}
                                    {% for error in form.desc.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.publication_type.label(class="form-label") }}
                                    {{ form.publication_type(class="form-control") }}
                                </div>

                            </div>

                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.publication_doi.label(class="form-label") }}
                                    {{ form.publication_doi(class="form-control") }}
                                    {% for error in form.publication_doi.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            {% if is_csv and csv_form %}
                            <div class="col-6 csv-only">
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ csv_form.has_header(class="form-check-input") }}
                                        {{ csv_form.has_header.label(class="form-check-label") }}
                                        {% for error in csv_form.has_header.errors %}
                                            <span style="color: red;">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 csv-only">
                                <div class="mb-3">
                                    {{ csv_form.delimiter.label(class="form-label") }}
                                    {{ csv_form.delimiter(class="form-control") }}
                                    {% for error in csv_form.delimiter.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="col-6">
                                <div class="mb-3">
                                    {{ form.tags.label(class="form-label") }}
                                    {{ form.tags(class="form-control") }}
                                    {% for error in form.tags.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            
                        </div>

                        <h1 class="h3 mb-3 mt-4">
                          Authors
                        </h1>
                        
                        <div class="alert alert-warning" role="alert">
                            <p class="p-0 m-0">
                                <i data-feather="alert-triangle"></i>
                                Authors cannot be modified in this version. They will remain the same as the original dataset.
                            </p>
                        </div>

                        <div class="row" style="padding-left: 2rem">

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author name</label>
                                <input class="form-control"
                                       disabled
                                       value="{{ current_user.profile.surname }}, {{ current_user.profile.name }}">
                            </div>

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author affiliation</label>
                                <input class="form-control"
                                       disabled value="{{ current_user.profile.affiliation }}">
                            </div>

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author ORCID</label>
                                <input class="form-control"
                                       disabled value="{{ current_user.profile.orcid }}">
                            </div>

                            <div class="col-12">
                                <div class="mb-3">
                                    <div id="authors">
                                        {% for author in dataset.ds_meta_data.authors[1:] %}
                                        <div class="row author" style="border:2px dotted #ccc;border-radius:10px;padding:10px;margin:10px 0; background-color: white">
                                            <div class="col-lg-6 col-12 mb-3">
                                                <label class="form-label">Name</label>
                                                <input class="form-control" value="{{ author.name }}" disabled>
                                            </div>

                                            <div class="col-lg-6 col-12 mb-3">
                                                <label class="form-label">Affiliation</label>
                                                <input class="form-control" value="{{ author.affiliation or '' }}" disabled>
                                            </div>

                                            <div class="col-lg-6 col-12 mb-3">
                                                <label class="form-label">ORCID</label>
                                                <input class="form-control" value="{{ author.orcid or '' }}" disabled>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                            </div>


                        </div>

                    </div>

                </div>

                <div class="row">

                    {% if error %}

                        <div class="mt-3 col-lg-6 col-12">
                            <span style="color: red;">{{ error }}</span>
                        </div>

                    {% endif %}

                </div>


            </div>
        </div>

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">

            <h1 class="h3 mb-3 mt-2">Existing Files</h1>
            
            <div style="padding-left: 2rem">
                <div class="alert alert-info" role="alert">
                    <p class="p-0 m-0">
                        These are the files already uploaded in the previous version. They will be included in the new version.
                    </p>
                </div>
                
                <ul class="list-group mb-3" id="existing-files-list">
                    {% for file in dataset.files %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i data-feather="file"></i> {{ file.name }}
                                <br>
                                <small class="text-muted">({{ file.get_formatted_size() }})</small>
                            </div>
                            <span class="badge bg-success">Existing</span>
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <h1 class="h3 mb-3 mt-4">Add New Files</h1>

            <div id="uploaded_models_form" style="padding-left: 2rem">

                <form action="{{ url_for('dataset.upload') }}" class="dropzone" id="myDropzone">
                    <div id="dropzone-text"></div>
                </form>

                <span class="text-danger" id="alerts" style="display: none">
                    </span>

                <ul class="mt-2" id="file-list"></ul>

                <script>
                    let dropzone = Dropzone.options.myDropzone = {
                        url: "/dataset/file/upload",
                        paramName: 'file',
                        maxFilesize: 10,
                        acceptedFiles: '{{ ".csv" if is_csv else ".uvl" }}',
                        init: function () {

                            let fileList = document.getElementById('file-list');
                            let dropzoneText = document.getElementById('dropzone-text');
                            let alerts = document.getElementById('alerts');

                            this.on('addedfile', function (file) {
                                let ext = file.name.split('.').pop();
                                let expectedExt = '{{ "csv" if is_csv else "uvl" }}';
                                
                                if (ext !== expectedExt) {
                                    this.removeFile(file);

                                    let alert = document.createElement('p');
                                    alert.textContent = 'Invalid file extension: ' + file.name + '. Expected .' + expectedExt;
                                    alerts.appendChild(alert);
                                    alerts.style.display = 'block';
                                }

                            });

                            this.on('success', function (file, response) {

                                let dropzone = this;

                                show_upload_dataset();

                                console.log("File uploaded: ", response);
                                // actions when UVL model is uploaded
                                let listItem = document.createElement('li');
                                let h4Element = document.createElement('h4');
                                h4Element.textContent = response.filename;
                                listItem.appendChild(h4Element);

                                // generate incremental id for form
                                let formUniqueId = generateIncrementalId();

                                /*
                                    ##########################################
                                    FORM BUTTON
                                    ##########################################
                                */
                                let formButton = document.createElement('button');
                                formButton.innerHTML = 'Show info';
                                formButton.classList.add('info-button', 'btn', 'btn-outline-secondary', "btn-sm");
                                formButton.style.borderRadius = '5px';
                                formButton.id = formUniqueId + "_button";

                                formButton.addEventListener('click', function () {
                                    if (formContainer.style.display === "none") {
                                        formContainer.style.display = "block";
                                        formButton.innerHTML = 'Hide info';
                                    } else {
                                        formContainer.style.display = "none";
                                        formButton.innerHTML = 'Add info';
                                    }
                                });

                                // append space
                                let space = document.createTextNode(" ");
                                listItem.appendChild(space);

                                /*
                                    ##########################################
                                    REMOVE BUTTON
                                    ##########################################
                                */

                                // remove button
                                let removeButton = document.createElement('button');
                                removeButton.innerHTML = 'Delete model';
                                removeButton.classList.add("remove-button", "btn", "btn-outline-danger", "btn-sm", "remove-button");
                                removeButton.style.borderRadius = '5px';

                                // append space
                                space = document.createTextNode(" ");
                                listItem.appendChild(space);

                                removeButton.addEventListener('click', function () {
                                    fileList.removeChild(listItem);
                                    this.removeFile(file);

                                    // Ajax request
                                    let xhr = new XMLHttpRequest();
                                    xhr.open('POST', '/dataset/file/delete', true);
                                    xhr.setRequestHeader('Content-Type', 'application/json');
                                    xhr.onload = function () {
                                        if (xhr.status === 200) {
                                            console.log('Deleted file from server');

                                            if (dropzone.files.length === 0) {
                                                document.getElementById("upload_dataset").style.display = "none";
                                                clean_upload_errors();
                                            }

                                        }
                                    };
                                    xhr.send(JSON.stringify({file: file.name}));
                                }.bind(this));

                                /*
                                    ##########################################
                                    APPEND BUTTONS
                                    ##########################################
                                */
                                listItem.appendChild(formButton);
                                listItem.appendChild(removeButton);

                                /*
                                    ##########################################
                                    UVL FORM
                                    ##########################################
                                */

                                // create specific form for UVL
                                let formContainer = document.createElement('div');
                                formContainer.id = formUniqueId + "_form";
                                formContainer.classList.add('uvl_form', "mt-3");
                                formContainer.style.display = "none";

                                formContainer.innerHTML = `
                                    <div class="row">
                                        <input type="hidden" value="${response.filename}" name="feature_models-${formUniqueId}-uvl_filename">
                                        <div class="col-12">
                                            <input class="row">
                                                <div class="col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label">Title</label>
                                                        <input type="text" class="form-control" name="feature_models-${formUniqueId}-title">
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label">Description</label>
                                                        <textarea rows="4" class="form-control" name="feature_models-${formUniqueId}-desc"></textarea>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label" for="publication_type">Publication type</label>
                                                        <select class="form-control" name="feature_models-${formUniqueId}-publication_type">
                                                            <option value="none">None</option>
                                                            <option value="availabletobuy">Available to Buy</option>
                                                            <option value="missing">Missing</option>
                                                            <option value="registered">Registered</option>
                                                            <option value="sold">Sold</option>
                                                            <option value="fined">Fined</option>
                                                            <option value="seen">Seen</option>
                                                            <option value="parked">Parked</option>
                                                            <option value="personal">Personal</option>
                                                            <option value="other">Other</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 col-6">
                                                    <div class="mb-3">
                                                        <label class="form-label" for="publication_doi">Publication DOI</label>
                                                        <input class="form-control" name="feature_models-${formUniqueId}-publication_doi" type="text" value="">
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Tags (separated by commas)</label>
                                                        <input type="text" class="form-control" name="feature_models-${formUniqueId}-tags">
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">UVL version</label>
                                                        <input type="text" class="form-control" name="feature_models-${formUniqueId}-uvl_version">
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label">Authors</label>
                                                        <div id="` + formContainer.id + `_authors">
                                                        </div>
                                                        <button type="button" class="add_author_to_uvl btn btn-secondary" id="` + formContainer.id + `_authors_button">Add author</button>
                                                    </div>
                                                </div>
                                            </input>
                                        </div>
                                    </div>
                                    `;

                                listItem.appendChild(formContainer);
                                fileList.appendChild(listItem);

                            });

                            this.on('error', function (file, response) {
                                console.error("Error uploading file: ", response);
                                let alert = document.createElement('p');
                                alert.textContent = 'File not valid: ' + file.name;
                                alerts.appendChild(alert);
                                alerts.style.display = 'block';
                            });

                        }
                    };


                </script>

            </div>
        </div>

    </div>

    <div class="row" id="upload_dataset" style="display: none">

        <div class="col-12">

            <hr>

            <h1 class="h3 mb-3 mt-2">Create New Version</h1>

            <div style="padding-left: 2rem">

                <label class="form-check">
                    <input id="agreeCheckbox" class="form-check-input" type="checkbox" value="">
                    <span class="form-check-label" style="font-size: 15px">
                                I agree to have my feature models automatically uploaded to Zenodo and made available to the public according to the <a
                            href="https://en.wikipedia.org/wiki/Open_science" target="_blank">Open Science</a> manifesto
                            </span>
                </label>

                <button id="upload_button" class="btn btn-primary mt-2" >
                    <i data-feather="upload" class="center-button-icon"></i>
                    Create New Version</button>

                <div id="loading" style="display: none">
                    <img width="40px" src="{{ url_for("static", filename="gifs/loading.svg") }}"/>
                    Creating new version, please wait...
                </div>

                <div class="row">
                    <div class="col-12 mb-3">

                    </div>
                </div>

                <div class="alert alert-error" role="alert" id="upload_error"
                     style="display: none">
                    <div class="alert-message">

                        <h4 class="alert-heading"><i class="align-middle" data-feather="alert-triangle"></i> Limited
                            connection to the Zenodo API</h4>
                        <p class="p-0 m-0">
                            There seems to be some kind of problem with the Zenodo API and synchronization of your
                            dataset
                            files may not be possible. We will save your files locally to eventually synchronize
                            them with
                            Zenodo. Sorry for the inconvenience, Zenodo is an external service and we can't do
                            anything about it.
                        </p>
                    </div>
                </div>


                <span class="text-danger mt-2" id="upload_error" style="display: none">

                    </span>

                <script>
                    const checkbox = document.getElementById('agreeCheckbox');
                    const upload_button = document.getElementById('upload_button');

                    checkbox.addEventListener('change', function () {
                        upload_button.disabled = !checkbox.checked;
                    });
                </script>

            </div>




        </div>

    </div>


{% endblock %}

{% block scripts %}
    <script src="{{ url_for('zenodo.scripts') }}"></script>
    <script src="{{ url_for('dataset.scripts') }}"></script>
    <script>
        // Show upload button immediately in edit mode
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('upload_dataset').style.display = 'block';
        });
        
        // Override upload button behavior for edit mode
        window.addEventListener('load', function() {
            const originalButton = document.getElementById('upload_button');
            if (originalButton) {
                // Clone the button to remove existing event listeners
                const newButton = originalButton.cloneNode(true);
                originalButton.parentNode.replaceChild(newButton, originalButton);
                
                // Add new event listener for edit mode
                newButton.addEventListener('click', function() {
                    clean_upload_errors();
                    show_loading();
                    
                    let check = check_title_and_description();
                    
                    if (check) {
                        const formData = {};
                        
                        ["basic_info_form", "uploaded_models_form"].forEach((formId) => {
                            const form = document.getElementById(formId);
                            const inputs = form.querySelectorAll('input:not([disabled]), select:not([disabled]), textarea:not([disabled])');
                            inputs.forEach(input => {
                                if (input.name) {
                                    formData[input.name] = formData[input.name] || [];
                                    formData[input.name].push(input.value);
                                }
                            });
                        });
                        
                        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                        const formUploadData = new FormData();
                        formUploadData.append('csrf_token', csrfToken);
                        
                        for (let key in formData) {
                            if (formData.hasOwnProperty(key)) {
                                formUploadData.set(key, formData[key]);
                            }
                        }
                        
                        fetch('/dataset/edit/{{ dataset.id }}', {
                            method: 'POST',
                            body: formUploadData
                        })
                        .then(response => {
                            if (response.ok) {
                                console.log('New version created successfully');
                                response.json().then(data => {
                                    console.log(data.message);
                                    window.location.href = "/dataset/list";
                                });
                            } else {
                                response.json().then(data => {
                                    console.error('Error: ' + data.message);
                                    hide_loading();
                                    write_upload_error(data.message);
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error in POST request:', error);
                            hide_loading();
                            write_upload_error('An error occurred while creating the new version');
                        });
                    } else {
                        hide_loading();
                    }
                });
            }
        });
    </script>
{% endblock %}
